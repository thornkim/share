<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>일정 가져오기 - ScheduleShare</title>
    <style>
        body { 
            font-family: -apple-system, sans-serif; 
            text-align: center; 
            padding-top: 80px; 
            background-color: #f9f9f9;
            color: #333;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { 
            display: inline-block; 
            padding: 15px 30px; 
            background: #4CAF50; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            margin-top: 20px;
            font-weight: bold;
        }
        .info-text { line-height: 1.6; color: #666; }
    </style>
</head>
<body>

    <div id="content">
        <div class="loader"></div>
        <h2 id="main-title">앱으로 연결 중입니다</h2>
        <p class="info-text">앱이 설치되어 있다면 자동으로 실행됩니다.<br>잠시만 기다려주세요.</p>
        <a href="#" id="manual-link" class="btn">일정 직접 가져오기</a>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const data = urlParams.get('data');
        
        // 실제 본인의 구글 플레이스토어 주소로 변경하세요.
        const playStoreUrl = "market://details?id=com.your.package.name"; 
        const deepLink = "myschedule://share?data=" + (data || "");

        if (data) {
            document.getElementById('manual-link').href = deepLink;

            // [Step 1] 앱 실행 시도
            location.href = deepLink;

            // [Step 2] 앱 실행 체크 및 브라우저 처리
            const checkTimestamp = Date.now();
            
            setTimeout(() => {
                const now = Date.now();

                // 1. 앱 실행 성공 (사용자가 앱을 보고 브라우저로 다시 돌아온 경우)
                if (now - checkTimestamp > 3000) {
                    // 카카오톡 인앱 브라우저 닫기 스킴
                    location.href = "kakaotalk://inappbrowser/close";
                    
                    // 일반 브라우저 창 닫기 시도
                    window.close();
                    
                    // 만약 닫히지 않는 경우를 대비해 문구 변경
                    document.getElementById('main-title').innerText = "연결이 완료되었습니다";
                    document.querySelector('.info-text').innerHTML = "앱에서 일정을 확인하세요.<br>이 창은 이제 닫으셔도 됩니다.";
                    document.getElementById('manual-link').style.display = "none";
                } 
                // 2. 앱 실행 실패 (시간이 거의 안 지나감 = 브라우저가 계속 활성 상태)
                else {
                    if (confirm("앱이 설치되어 있지 않거나 연결되지 않았습니다.\n설치 페이지로 이동할까요?")) {
                        location.href = playStoreUrl;
                    }
                }
            }, 2500);

        } else {
            document.getElementById('content').innerHTML = "<h2>잘못된 접근입니다.</h2><p>데이터 정보가 누락되었습니다.</p>";
        }
    </script>
</body>
</html>
</script>
